---
- hosts: localhost
  vars_files:
    - "{{ playbook_dir }}/vars.yml"
  tasks:
    - debug:
        msg: "========= ðŸš€ HOUSTON, WE ARE GO FOR LAUNCH ðŸš€ ========="

    - name: Install docker on localhost
      pip:
        name: docker
        state: present

    - name: Create docker network
      docker_network:
        name: ps2alerts
        state: present

    - name: Start Traefik Router
      docker_container:
        name: ps2alerts-router
        image: traefik:v2.2
        state: started
        recreate: yes
        volumes:
          - ./traefik/logs:/var/log/traefik
          - ./traefik/config:/config
          - ./traefik/traefik.yml:/etc/traefik/traefik.yml
          - /var/run/docker.sock:/var/run/docker.sock
          - "{{ certs_dir }}:/etc/certs"
        labels:
          traefik.enable: "true"
          traefik.backend: "traefik"
          traefik.port: "8080"
        ports:
          - 80:80
          - 443:443
          - 8080:8080

    - name: Start Database
      docker_container:
        name: ps2alerts-db
        image: mongo:4.2
        state: started
        volumes:
          - ./mongo/init/init-mongo.js:/docker-entrypoint-initdb.d/init-monjo.js
          - ./mongo/mongod.conf:/etc/mongod.conf
          - ./mongo:/data/mongo-host
          - "{{ db_dir }}:/data/db"
        env:
          MONGO_INITDB_DATABASE: ps2alerts
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: foobar
        ports:
          - 27017-27019:27017-27019
        networks:
          - name: "ps2alerts"
        labels:
          traefik.enable: "false"

    - name: Start Redis
      docker_container:
        name: ps2alerts-redis
        image: redis:5
        state: started
        volumes:
          - "{{ redis_dir }}:/data"
        ports:
          - 6379:6379
        networks:
          - name: "ps2alerts"
        labels:
          traefik.enable: "false"
