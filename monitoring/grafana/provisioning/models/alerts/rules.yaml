apiVersion: 1
groups:
  - orgId: 1
    name: Aggregator
    folder: Alerts - Aggregator
    interval: 30s
    rules:
      - uid: FPR6bfPVz
        title: Event Type processing time
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: histogram_quantile(0.95, sum by(le, eventType) (rate(aggregator_event_processing_histogram_bucket{environment="ps2"}[$__rate_interval])))
              interval: ""
              intervalMs: 15000
              legendFormat: __auto
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              settings:
                mode: dropNN
              type: reduce
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        dashboardUid: 1v3LFaP4z
        panelId: 12
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          __dashboardUid__: 1v3LFaP4z
          __panelId__: "12"
        labels:
          app: aggregator
        isPaused: false
      - uid: OXU9BfP4k
        title: No active alerts for 2 hours
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 10800
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: sum by(type) (aggregator_instances_gauge{type="active"})
              interval: ""
              intervalMs: 15000
              legendFormat: __auto
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 10800
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 10800
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        dashboardUid: 1v3LFaP4z
        panelId: 26
        noDataState: NoData
        execErrState: Error
        for: 2h
        annotations:
          __dashboardUid__: 1v3LFaP4z
          __panelId__: "26"
        labels:
          app: aggregator
        isPaused: false
      - uid: Ne1qBBEVk
        title: Active Alerts - Overdue
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 10800
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: sum by(type) (aggregator_instances_gauge{type="overdue"})
              interval: ""
              intervalMs: 15000
              legendFormat: __auto
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 10800
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 10800
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        dashboardUid: 1v3LFaP4z
        panelId: 26
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          __dashboardUid__: 1v3LFaP4z
          __panelId__: "26"
        labels:
          app: aggregator
        isPaused: false
      - uid: gLYGYfEVk
        title: Fail messages - discards high
        condition: D
        data:
          - refId: A
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: sum by(type) (increase(aggregator_queue_messages_count{type="discard"}[$__rate_interval]))
              interval: ""
              intervalMs: 15000
              legendFormat: __auto
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: reduce
          - refId: D
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - D
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: D
              type: threshold
        dashboardUid: 1v3LFaP4z
        panelId: 24
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          __dashboardUid__: 1v3LFaP4z
          __panelId__: "24"
        labels:
          app: aggregator
        isPaused: false
      - uid: 5AdeQBPVk
        title: PS2Alerts API roundtimes
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: histogram_quantile(0.99, sum by(le, endpoint) (rate(aggregator_external_requests_histogram_bucket{provider="ps2alerts_api"}[$__rate_interval])))
              interval: ""
              intervalMs: 15000
              legendFormat: __auto
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              settings:
                mode: dropNN
              type: reduce
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.05
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        dashboardUid: 1v3LFaP4z
        panelId: 33
        noDataState: NoData
        execErrState: Error
        for: 1m
        annotations:
          __dashboardUid__: 1v3LFaP4z
          __panelId__: "33"
        labels:
          app: aggregator
        isPaused: false
      - uid: 0BuSlfP4z
        title: External endpoint unsuccessful requests
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              exemplar: false
              expr: sum by(result, provider) (increase(aggregator_external_requests_count{environment="ps2", result!="success"}[$__rate_interval])) / 4
              hide: false
              instant: false
              interval: ""
              intervalMs: 15000
              legendFormat: '{{provider}}: {{result}}'
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              settings:
                mode: dropNN
              type: reduce
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        dashboardUid: 1v3LFaP4z
        panelId: 32
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          __dashboardUid__: 1v3LFaP4z
          __panelId__: "32"
        labels:
          app: aggregator
        isPaused: false
      - uid: 0Ge8_BE4k
        title: Census errors / retries
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: sum by(result) (increase(aggregator_external_requests_count{environment="ps2", result=~"error|retry", provider="census"}[$__rate_interval]))
              interval: ""
              intervalMs: 15000
              legendFormat: __auto
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        dashboardUid: 1v3LFaP4z
        panelId: 28
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          __dashboardUid__: 1v3LFaP4z
          __panelId__: "28"
        labels:
          app: aggregator
        isPaused: false
      - uid: gAfulfP4z
        title: PS2Alerts API errors / retries
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: sum by(result) (increase(aggregator_external_requests_count{environment="ps2", result=~"error|retry", provider="ps2alerts_api"}[$__rate_interval]))
              interval: ""
              intervalMs: 15000
              legendFormat: __auto
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              settings:
                mode: dropNN
              type: reduce
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        dashboardUid: 1v3LFaP4z
        panelId: 34
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          __dashboardUid__: 1v3LFaP4z
          __panelId__: "34"
        labels:
          app: aggregator
        isPaused: false
      - uid: fzymXBP4k
        title: Census endpoint roundtimes
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: histogram_quantile(0.99, sum by(le, endpoint) (rate(aggregator_external_requests_histogram_bucket{environment="ps2", provider="census"}[$__rate_interval]))) / 4
              interval: ""
              intervalMs: 15000
              legendFormat: __auto
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              settings:
                mode: dropNN
              type: reduce
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        dashboardUid: 1v3LFaP4z
        panelId: 20
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          __dashboardUid__: 1v3LFaP4z
          __panelId__: "20"
        labels:
          app: aggregator
        isPaused: false
      - uid: snTfjfPVz
        title: Broker cache rates
        condition: thresholds
        data:
          - refId: A
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: sum(rate(aggregator_broker_count{environment="ps2", result="cache_hit", broker="character"}[$__rate_interval]))
              hide: false
              interval: ""
              intervalMs: 15000
              legendFormat: '{{broker}}: {{result}}'
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: sum(rate(aggregator_broker_count{environment="ps2", result="cache_miss", broker="character"}[$__rate_interval]))
              hide: false
              interval: ""
              intervalMs: 15000
              legendFormat: '{{broker}}: {{result}}'
              maxDataPoints: 43200
              range: true
              refId: B
          - refId: character
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: $A/($A+$B)*100
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: character
              type: math
              window: ""
          - refId: D
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: sum(rate(aggregator_broker_count{environment="ps2", result="cache_hit", broker="item"}[$__rate_interval]))
              hide: false
              interval: ""
              intervalMs: 15000
              legendFormat: '{{broker}}: {{result}}'
              maxDataPoints: 43200
              range: true
              refId: D
          - refId: E
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              datasource:
                type: prometheus
                uid: PBFA97CFB590B2093
              editorMode: builder
              expr: sum(rate(aggregator_broker_count{environment="ps2", result="cache_miss", broker="item"}[$__rate_interval]))
              hide: false
              interval: ""
              intervalMs: 15000
              legendFormat: '{{broker}}: {{result}}'
              maxDataPoints: 43200
              range: true
              refId: E
          - refId: item
            relativeTimeRange:
              from: 21600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: $D/($D+$E)*100
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: item
              type: math
              window: ""
          - refId: char_rate
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: character
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: char_rate
              settings:
                mode: dropNN
              type: reduce
          - refId: item_rate
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: item
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: item_rate
              settings:
                mode: dropNN
              type: reduce
          - refId: thresholds
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: $char_rate < 80 || $item_rate < 80
              hide: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: thresholds
              type: math
        dashboardUid: 1v3LFaP4z
        panelId: 35
        noDataState: NoData
        execErrState: Error
        for: 10m
        annotations:
          __dashboardUid__: 1v3LFaP4z
          __panelId__: "35"
        labels:
          app: aggregator
        isPaused: false
